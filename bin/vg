#! /bin/zsh
# contents: Vim grep wrapper.
#
# Copyright Â© 2008 Nikolai Weibull <now@bitwi.se>

setopt extendedglob

if (( $# < 2 )); then
  print -u 2 "Usage: $0 PATTERN FILE..."
  return 1
fi

local regex=$1; shift

vim \
  -c 'let saved_grepprg = &grepprg' \
  -c 'set grepprg=grep\ -n\ -P\ --\ $*\ /dev/null' \
  -c 'let saved_shellpipe = &shellpipe' \
  -c 'set shellpipe=>\ %s\ 2>&1' \
  -c "silent! grep '${regex//(#m)[%#]/\\$MATCH}' ${^${(@qq)${(@)*//(#m)[%#]/\\$MATCH}}}" \
  -c 'let &shellpipe = saved_shellpipe' \
  -c 'unlet saved_shellpipe' \
  -c 'let &grepprg = saved_grepprg' \
  -c 'unlet saved_grepprg' \
  -c 'if len(filter(getqflist(), "v:val.valid")) == 0 | quit | else | cwindow | endif' \
