#! @ZSHELL@

root=$HOME

dar_options=(--noconf
             --fs-root $root
             --no-warn
             --mincompr 1024
             --bzip2
             --slice 700M
             -Q
             --batch $HOME/var/lib/dar/password

             --exclude-compression \*.gz
             --exclude-compression \*.bz2
             --exclude-compression \*.gif
             --exclude-compression \*.idx
             --exclude-compression \*.jpeg
             --exclude-compression \*.jpg
             --exclude-compression \*.pack
             --exclude-compression \*.png
             --exclude-compression \*.tgz)

# Prune cache and temporary directories
dar_options+=(--prune .Spotlight-V100
              --prune .TemporaryItems
              --prune .Trash
              --prune .Trashes
              --prune .Xauthority
              --prune .adobe
              --prune .agency9
              --prune .bash_history
              --prune .cache
              --prune .dropbox
              --prune .dvdcss
              --prune .fontconfig
              --prune .fseventsd
              --prune .gegl-\*
              --prune .gem
              --prune .ido.last
              --prune .irb_history
              --prune .lesshst
              --prune .macports
              --prune .parallel
              --prune .revdep-rebuild\*
              --prune .rnd
              --prune .ruby_inline
              --prune .sqlite_history
              --prune .terminfo
              --prune .thumbnails
              --prune .yard
              --prune Documents/Google\ Drive
              --prune Documents/Native\ Instruments/Traktor\ \*/Backup
              --prune Documents/Native\ Instruments/Traktor\ \*/Settings/Default\ Settings
              --prune Dropbox
              --prune Library/Caches
              --prune Library/Application\ Support/CrashReporter
              --prune Library/Application\ Support/Cultured\ Code/Things/Backups
              --prune Library/Application\ Support/Evernote
              --prune Library/Application\ Support/Firefox/Crash\ Reports
              --prune Library/Application\ Support/Firefox/Profiles/\*/.parentlock
              --prune Library/Application\ Support/Firefox/Profiles/\*/adblockplus
              --prune Library/Application\ Support/Firefox/Profiles/\*/bookmarkbackups
              --prune Library/Application\ Support/Firefox/Profiles/\*/downloads.sqlite
              --prune Library/Application\ Support/Firefox/Profiles/\*/sessionstore.bak
              --prune Library/Application\ Support/Google/Chrome
              --prune Library/Application\ Support/Google/Picasa3/cache
              --prune Library/Application\ Support/Google/Picasa3/db3/bigthumbs_0.db
              --prune Library/Application\ Support/Google/Picasa3/db3/previews_0.db
              --prune Library/Application\ Support/Google/Picasa3/db3/thumbs_0.db
              --prune Library/Application\ Support/Google/Picasa3/db3/thumbs_2.db
              --prune Library/Application\ Support/Google/Picasa3/db3/thumbs2_0.db
              --prune Library/Application\ Support/Google/Picasa3/network.log
              --prune Library/Application\ Support/Google/Picasa3/synclog
              --prune Library/Application\ Support/Google/Picasa3/temp
              --prune Library/Application\ Support/Google/Picasa3/tmp
              --prune Library/Application\ Support/MobileSync
              --prune Library/Application\ Support/Preview
              --prune Library/Application\ Support/uTorrent/\*.old
              --prune Library/Application\ Support/uTorrent/\*.torrent
              --prune Library/Developer/Shared
              --prune Library/Gentoo
              --prune Library/Google/GoogleSoftwareUpdate
              --prune Library/iTunes/iPhone\ Software\ Updates
              --prune Library/Logs
              --prune Library/Preferences/Macromedia
              --prune Library/Preferences/SDMHelpData
              --prune Library/PubSub
              --prune Library/Safari
              --prune Library/Widgets
              --prune Projects/u/build/data/UnicodeData.marshalled
              --prune Projects/u/build/data/NormalizationTest.txt
              --prune Projects/u/test/normalize.rb
              --prune cbt
              --prune opt
              --prune tmp
              --prune var/run
              --prune \*/.generated
              --prune \*/autom4te.cache)

# Prune uninteresting files and directories
dar_options+=(--prune .recently-used.xbel
              --prune .subversion
              --prune \*/.deps
              --prune \*/.libs)

# Prune stuff that can easily be regenerated
dar_options+=(--prune Documents/Native\ Instruments/Traktor/Settings/Default\ Settings
              --prune Library/Application\ Support/MAME\ OS\ X
              --prune .wine
              --prune Downloads
              --prune Movies
              --prune Music
              --prune Pictures
              --prune src)

# Prune stuff under revision control
dar_options+=(--prune .Xresources
              --prune .dircolors
              --prune .emacs
              --prune .emacs.d
              --prune .fonts.conf
              --prune .gimp-\*
              --prune .gitconfig
              --prune .gitk
              --prune .gtkrc-2.0
              --prune .indent.pro
              --prune .inputrc
              --prune .irbrc
              --prune .mailcap
              --prune .mplayer
              --prune .sbclrc
              --prune .screenrc
              --prune .terminator
              --prune .vim
              --prune .viminfo
              --prune .vimperator
              --prune .vimperatorrc
              --prune .vimrc
              --prune .xmonad
              --prune .xsession
              --prune .zsh
              --prune .zshenv
              --prune .zshistory
              --prune bin
              --prune share)

dar_options+=(--exclude aclocal.m4
              --exclude config.log
              --exclude config.status
              --exclude configure
              --exclude core
              --exclude core.\*
              --exclude \*~
              --exclude \*.class
              --exclude \*.mp3
              --exclude \*.o
              --exclude \*.swp)

backupdest=~/Documents/Google\ Drive/Backups
datestring=$(date +%Y-%m-%d)
filename=$backupdest/${${root#/}//\//-}-$datestring
filenames=($backupdest/*.dar(Nom))

mkdir -p $backupdest || exit $?

if [[ $1 == diff ]]; then
  if (( $#filenames == 0 )); then
    print -u 2 "No previous backup"
    exit 1
  fi
  base=${${filenames[1]:r}%%.[[:digit:]]##}
  if [[ $base == $filename ]]; then
    print -u 2 "backup-home: base is from same day as diff"
    exit 1
  fi
  filename=$filename-diff
  dar_options+=(-A $base)
fi

# TODO On Unix: eval $(keychain --eval --quiet --noask --dir $HOME/.keychain id_dsa)
dar --create $filename $dar_options |& \
  sed '/^Warning, the archive .* has been encrypted. A wrong key is not possible to detect, it would cause DAR to report the archive as corrupted$/d
        /^-J is only useful with -A option, for the archive of reference$/d
        /^Error reading EA for .* : Permission denied$/d
        /^Cannot read directory contents: .* : Error opening directory: .* : Permission denied$/d
        /^$/d
        /^ --------------------------------------------$/d
        /^ [0-9]* inode(s) saved$/d
        /^ with [0-9]* hard link(s) recorded$/d
        /^ [0-9]* inode(s) changed at the moment of the backup$/d
        /^ [0-9]* inode(s) not saved (no inode\/file change)/d
        /^ 0 inode(s) failed to save (filesystem error)$/d
        /^ [0-9]* inode(s) ignored (excluded by filters)$/d
        /^ [0-9]* inode(s) recorded as deleted from reference backup$/d
        /^ Total number of inodes considered: [0-9]*$/d
        /^ EA saved for [0-9]* inode(s)$/d'
