emulate -L zsh
setopt extendedglob

autoload -U zle/select-match-from-menu-widget

zmodload -i zsh/parameter

local -a reply
zle/select-match-from-menu-widget $history || return $?

# Find the history lines that contain the matched string and go to the last
# one.  This allows accept-line-and-down-history etc. to work.
local -a lines
local matchq=${reply[1]//(#m)[\][()\\*?#<>~^]/\\$MATCH}
lines=(${(kon)history[(R)$matchq]})
HISTNO=$lines[-1]
CURSOR=$reply[2]
